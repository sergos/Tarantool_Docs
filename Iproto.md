# Iproto #

У Tarantool есть один транзакционный тред TX. Для того
чтобы работать с сетью (сокет, TCP), существует отдельный тред -- iproto.
Iproto принимает запросы из сети, обрабатывает протокол Tarantool,
передаёт запрос в TX и запускает пользовательский запрос в отдельном
файбере.

Рассмотрим как происходит общение между TX и Iproto тредами. В греческой
мифологии Харон -- это перевозчик душ умерших через реку Стикс, отделяюшую
мир живых от мира мертвых.

Здесь:

* Харон &mdash; с помощью cbus message уведомляет iproto тред о новых данных
    в obuf и возвращает в tx тред позицию в obuf, которая была успешно
    сброшена в сеть.

* река Стикс &mdash; cpipe;
* лодка &mdash; cbus message;
* мир живых &mdash; TX тред;
* мир мертвых &mdash; iproto тред

(Пока такая картинка, чуть позже сделаю анимацию)
![Iproto Kharon](/images/iproto_kharon.jpg)

На gif'ке изображено следующее: cbus message инициируется в тот момент
когда данные появляются в TX треде. Далее с помощью cbus message данные
передаются в iproto тред. Часть данных из iproto сбрасывается в сеть, т.е.
меняется wpos у obuf, соответсвенно это новое знвчение передается в TX тред
посредством cbus message. Аналогично делается и для ibuf только в другую
сторону (из iproto в TX)

---

## IBuf ##
- [ ] Вставить картинку
Один из двух сетевых буферов, предназначенный для чтения из сокета.
Он работает с запросами, приходящими из сети, причем для обработки запросов
они должны быть непрерывны в памяти. Поэтому `IBuf` запрашивает у
`Slab cache` фрагмент памяти и использует его, а когда не хватает &mdash;
берет побольше и переносит информацию из предыдущего фрагмента. У IBuf
даже API нет, это просто структура с четырьмя указателями, буфером и
методом, который умеет делать realloc.

Удобнее всего использовать по два таких буфера на каждое сетевое
подключение. При чтении из одного сокета Tarantool вычитывает в один буфер
сразу много запросов. Очевидно, после обработки запроса он уже не нужен,
но, поскольку он живет в одном буфере с еще нужными запросами, удалить
его нельзя. Поэтому по мере накопления запросов в одном буфере берётся
следующий буфер &mdash; тогда рано или поздно все запросы из первого
буфера будут выполнены и его, буфер, можно будет целиком освободить.

## OBuf ##
- [ ] Вставить картинку
Второй из сетевых буферов, предназначенный для отправки ответа в сеть.
Он не обязан быть непрерывным в памяти. Самое главное, что он умеет
делать &mdash; сохранять позицию в своем буфере. Когда Tarantool отвечает
на запрос по сети, первые несколько байтов ответа &mdash; это размер
ответа. А размер мы не знаем, пока не сформируем весь ответ. Поэтому мы
запоминаем позицию в памяти, дописываем все данные, которые потребовались,
после чего возвращаемся на ту самую позицию, меняем уже посчитанный размер
и работаем дальше.


### Todo

- [ ] Сделать гифку
- [X] Расписать и нарисовать про obuf и ibuf + двойная буферизация
- [ ] Сделать замечание про multithread iproto https://github.com/tarantool/tarantool/issues/5645

### In Progress

- [ ] Архитектура iproto глобально
